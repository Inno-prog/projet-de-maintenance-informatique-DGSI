<div class="modal-overlay" *ngIf="showForm">
  <div class="modal-content form-modal" (click)="$event.stopPropagation()">
    <form [formGroup]="prestationForm" (ngSubmit)="onSubmit()" class="prestation-form">
      <h2 class="form-title">{{ isEditMode ? 'Modifier la Prestation' : 'Nouvelle Prestation' }}</h2>
    <!-- Section Informations de base -->
    <div class="form-section">
      <div class="section-header">
        <h3>Informations de base</h3>
        <div class="section-divider"></div>
      </div>

      <div class="form-group">
        <label for="nomPrestataire">Prestataire</label>
        <select
          id="nomPrestataire"
          formControlName="nomPrestataire"
          class="line-input"
          [class.error]="prestationForm.get('nomPrestataire')?.invalid && prestationForm.get('nomPrestataire')?.touched"
        >
          <option value="" disabled>Sélectionnez un prestataire</option>
          <option *ngFor="let prestataire of prestataires" [value]="prestataire.nom">
            {{ prestataire.nom }}
          </option>
        </select>
        <div class="input-line" [class.error]="prestationForm.get('nomPrestataire')?.invalid && prestationForm.get('nomPrestataire')?.touched"></div>
        <div class="error-message" *ngIf="prestationForm.get('nomPrestataire')?.invalid && prestationForm.get('nomPrestataire')?.touched">
          <span *ngIf="prestationForm.get('nomPrestataire')?.errors?.['required']">Le prestataire est requis</span>
        </div>
      </div>

      <div class="form-group">
        <label for="nomPrestation">Item</label>
        <select
          id="nomPrestation"
          formControlName="nomPrestation"
          class="line-input"
          [class.error]="prestationForm.get('nomPrestation')?.invalid && prestationForm.get('nomPrestation')?.touched"
        >
          <option value="" disabled>Sélectionnez un item</option>
          <option *ngFor="let item of items" [value]="item.nomItem">
            {{ item.nomItem }}
          </option>
        </select>
        <div class="input-line" [class.error]="prestationForm.get('nomPrestation')?.invalid && prestationForm.get('nomPrestation')?.touched"></div>
        <div class="error-message" *ngIf="prestationForm.get('nomPrestation')?.invalid && prestationForm.get('nomPrestation')?.touched">
          <span *ngIf="prestationForm.get('nomPrestation')?.errors?.['required']">L'item est requis</span>
        </div>
        <!-- Ajoutez cette section après le champ de sélection de l'item -->
        <div *ngIf="selectedItem" class="prestation-counter">
          <p class="counter-info">
            Prestations créées pour <strong>{{selectedItem.nomItem}}</strong> :
            <span [class.limit-reached]="existingPrestationsCount >= maxQuantityForTrimestre">
              {{existingPrestationsCount}}/{{maxQuantityForTrimestre}}
            </span>
          </p>
          <p *ngIf="existingPrestationsCount >= maxQuantityForTrimestre" class="warning-message">
            ⚠️ Le nombre limite de prestations pour cet item est atteint
          </p>
          <p *ngIf="existingPrestationsCount < maxQuantityForTrimestre" class="info-message">
            Il reste {{maxQuantityForTrimestre - existingPrestationsCount}} prestation(s) disponible(s)
          </p>
        </div>
      </div>

      <div class="form-group">
        <label for="montantPrest">Montant</label>
        <input
          type="number"
          id="montantPrest"
          formControlName="montantPrest"
          placeholder="0"
          class="line-input"
          [class.error]="prestationForm.get('montantPrest')?.invalid && prestationForm.get('montantPrest')?.touched"
        />
        <div class="input-line" [class.error]="prestationForm.get('montantPrest')?.invalid && prestationForm.get('montantPrest')?.touched"></div>
        <div class="error-message" *ngIf="prestationForm.get('montantPrest')?.invalid && prestationForm.get('montantPrest')?.touched">
          <span *ngIf="prestationForm.get('montantPrest')?.errors?.['required']">Le montant est requis</span>
          <span *ngIf="prestationForm.get('montantPrest')?.errors?.['min']">Le montant doit être positif</span>
        </div>
      </div>

      <div class="form-group">
        <label for="equipementsUtilises">Équipements utilisés</label>
        <select
          id="equipementsUtilises"
          formControlName="equipementsUtilises"
          class="line-input"
          multiple
          (change)="onEquipementSelectionChange($event)"
        >
          <option *ngFor="let equipement of equipements" [value]="equipement.id">
            {{ equipement.nomEquipement }} ({{ equipement.typeEquipement }})
          </option>
        </select>
        <div class="input-line"></div>
        <div class="selected-equipements" *ngIf="selectedEquipements.length > 0">
          <small>Équipements sélectionnés: {{ selectedEquipements.length }}</small>
        </div>
      </div>

      <div class="form-group">
        <label for="trimestre">Trimestre</label>
        <select
          id="trimestre"
          formControlName="trimestre"
          class="line-input"
          [class.error]="prestationForm.get('trimestre')?.invalid && prestationForm.get('trimestre')?.touched"
        >
          <option value="" disabled>Sélectionnez un trimestre</option>
          <option *ngFor="let trimestre of trimestreOptions" [value]="trimestre.value">
            {{ trimestre.label }}
          </option>
        </select>
        <div class="input-line" [class.error]="prestationForm.get('trimestre')?.invalid && prestationForm.get('trimestre')?.touched"></div>
        <div class="error-message" *ngIf="prestationForm.get('trimestre')?.invalid && prestationForm.get('trimestre')?.touched">
          <span *ngIf="prestationForm.get('trimestre')?.errors?.['required']">Le trimestre est requis</span>
        </div>
      </div>
    </div>

    <!-- Section Période -->
    <div class="form-section">
      <div class="section-header">
        <h3>Période</h3>
        <div class="section-divider"></div>
      </div>

      <div class="form-group">
        <label for="dateDebut">Date de début</label>
        <input
          type="date"
          id="dateDebut"
          formControlName="dateDebut"
          class="line-input"
          [class.error]="prestationForm.get('dateDebut')?.invalid && prestationForm.get('dateDebut')?.touched"
        />
        <div class="input-line" [class.error]="prestationForm.get('dateDebut')?.invalid && prestationForm.get('dateDebut')?.touched"></div>
        <div class="error-message" *ngIf="prestationForm.get('dateDebut')?.invalid && prestationForm.get('dateDebut')?.touched">
          <span *ngIf="prestationForm.get('dateDebut')?.errors?.['required']">La date de début est requise</span>
        </div>
      </div>

      <div class="form-group">
        <label for="dateFin">Date de fin</label>
        <input
          type="date"
          id="dateFin"
          formControlName="dateFin"
          class="line-input"
          [class.error]="prestationForm.get('dateFin')?.invalid && prestationForm.get('dateFin')?.touched"
        />
        <div class="input-line" [class.error]="prestationForm.get('dateFin')?.invalid && prestationForm.get('dateFin')?.touched"></div>
        <div class="error-message" *ngIf="prestationForm.get('dateFin')?.invalid && prestationForm.get('dateFin')?.touched">
          <span *ngIf="prestationForm.get('dateFin')?.hasError('required')">La date de fin est requise</span>
        </div>
      </div>
    </div>

    <!-- Section Statut et Description -->
    <div class="form-section">
      <div class="section-header">
        <h3>Statut et Description</h3>
        <div class="section-divider"></div>
      </div>

      <div class="form-group">
        <label for="statut">Statut</label>
        <select
          id="statut"
          formControlName="statut"
          class="line-input"
          [class.error]="prestationForm.get('statut')?.invalid && prestationForm.get('statut')?.touched"
        >
          <option value="" disabled>Sélectionnez un statut</option>
          <option *ngFor="let statut of statutOptions" [value]="statut.value">
            {{ statut.label }}
          </option>
        </select>
        <div class="input-line" [class.error]="prestationForm.get('statut')?.invalid && prestationForm.get('statut')?.touched"></div>
        <div class="error-message" *ngIf="prestationForm.get('statut')?.invalid && prestationForm.get('statut')?.touched">
          <span *ngIf="prestationForm.get('statut')?.errors?.['required']">Le statut est requis</span>
        </div>
      </div>

      <div class="form-group">
        <label for="description">Description</label>
        <textarea
          id="description"
          formControlName="description"
          placeholder="Ajoutez une description détaillée de la prestation (optionnel)"
          class="line-input"
          rows="4"
        ></textarea>
        <div class="input-line"></div>
      </div>
    </div>

    <!-- Actions -->
    <div class="form-actions">
      <button type="button" class="btn btn-outline" (click)="onCancel()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Annuler
      </button>
      <button type="submit" class="btn btn-primary" [disabled]="!prestationForm.valid">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        {{ isEditMode ? 'Modifier' : 'Créer' }}
      </button>
    </div>
  </form>
  </div>
</div>
